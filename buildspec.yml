version: 0.2

phases:
  install:
    on-failure: ABORT
    runtime-versions:
      python: "3.11"
      nodejs: "20"
    commands:
      - export PATH=$HOME/.local/bin:$PATH
      - |
        [ -n "$(which poetry)" ] || \
        (curl -sSL https://install.python-poetry.org | python3 - && poetry self add poetry-plugin-lambda-build)
      - |
        [ -n "$(which terraform)" ] || \
        (curl -sSL https://releases.hashicorp.com/terraform/1.9.5/terraform_1.9.5_linux_amd64.zip -o /tmp/terraform.zip && unzip /tmp/terraform.zip -d $HOME/.local/bin)
      - |
        [ -n "$(which gauge)" ] || \
        (curl -sSL https://github.com/getgauge/gauge/releases/download/v1.6.8/gauge-1.6.8-linux.x86_64.zip -o /tmp/gauge.zip && unzip /tmp/gauge.zip -d $HOME/.local/bin)
  pre_build:
    on-failure: ABORT
    commands:
      - cd ${CODEBUILD_SRC_DIR}/frontend && npm install --no-progress
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry install
      - |
        cd ${CODEBUILD_SRC_DIR}/terraform && echo -e "terraform {\n  backend \"s3\" {}\n}" > _override.tf && \
        terraform init \
          -backend-config="bucket=${S3_BUCKET_TFSTATE}" \
          -backend-config="key=${S3_KEY_TFSTATE}" \
          -backend-config="region=${AWS_REGION}"
      - cd ${CODEBUILD_SRC_DIR}/gauge && npm install --no-progress && gauge install && gauge config check_updates false
  build:
    on-failure: ABORT
    commands:
      - cd ${CODEBUILD_SRC_DIR}/frontend && npm run check-format
      - cd ${CODEBUILD_SRC_DIR}/frontend && npm run lint
      # - cd ${CODEBUILD_SRC_DIR}/frontend && npm run test
      - cd ${CODEBUILD_SRC_DIR}/frontend && npm run build
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry run black --check .
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry run isort --check .
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry run flake8
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry run mypy .
      - cd ${CODEBUILD_SRC_DIR}/api/hello && poetry run python -m unittest && poetry build-lambda
  post_build:
    on-failure: ABORT
    commands:
      - |
        [ ${CODEBUILD_BUILD_SUCCEEDING} -eq 1 ] && cd ${CODEBUILD_SRC_DIR}/terraform && terraform apply -input=false -auto-approve
      - cd ${CODEBUILD_SRC_DIR}/gauge && npm run test

artifacts:
  files:
    - "**/*"

cache:
  paths:
    - /root/.local/**/*
    - /root/.cache/pip/**/*
    - terraform/.terraform/**/*
